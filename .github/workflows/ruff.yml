name: Ruff Lint and Format

on: [push, pull_request]

jobs:
  setup:
    uses: ./.github/workflows/python-setup.yml
    # Не нужны outputs для ruff
    
  lint:
    name: Ruff Lint
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ needs.setup.outputs.python-version }}-pip-
            
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
          # Если есть зависимости проекта
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          
      - name: Run Ruff Linter
        run: |
          echo "Running ruff linter..."
          
          # Проверяем директории по порядку
          DIRS_TO_CHECK=""
          
          if [ -d "src" ]; then
            DIRS_TO_CHECK="$DIRS_TO_CHECK src"
          fi
          
          if [ -d "tests" ]; then
            DIRS_TO_CHECK="$DIRS_TO_CHECK tests"
          fi
          
          if [ -n "$DIRS_TO_CHECK" ]; then
            echo "Checking directories: $DIRS_TO_CHECK"
            ruff check --output-format=github $DIRS_TO_CHECK
          else
            # Если нет стандартных директорий, ищем все .py файлы
            echo "No standard directories found, checking all Python files..."
            PY_FILES=$(find . -name "*.py" -type f -not -path "./.*" | grep -v __pycache__)
            if [ -n "$PY_FILES" ]; then
              echo "Found Python files:"
              echo "$PY_FILES"
              ruff check --output-format=github $(echo "$PY_FILES" | tr '\n' ' ')
            else
              echo "No Python files found to lint"
            fi
          fi
          
  format:
    name: Ruff Format Check
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ needs.setup.outputs.python-version }}-pip-
            
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          
      - name: Run Ruff Format Check
        run: |
          echo "Checking formatting..."
          
          DIRS_TO_CHECK=""
          
          if [ -d "src" ]; then
            DIRS_TO_CHECK="$DIRS_TO_CHECK src"
          fi
          
          if [ -d "tests" ]; then
            DIRS_TO_CHECK="$DIRS_TO_CHECK tests"
          fi
          
          if [ -n "$DIRS_TO_CHECK" ]; then
            echo "Checking formatting for: $DIRS_TO_CHECK"
            ruff format --check --diff $DIRS_TO_CHECK
          else
            echo "No standard directories to check, looking for Python files..."
            PY_FILES=$(find . -name "*.py" -type f -not -path "./.*" | grep -v __pycache__)
            if [ -n "$PY_FILES" ]; then
              echo "Checking formatting for Python files"
              ruff format --check --diff $(echo "$PY_FILES" | tr '\n' ' ')
            else
              echo "No Python files found to check formatting"
            fi
          fi
