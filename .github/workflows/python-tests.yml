name: Python Tests

on: [push, pull_request]

jobs:
  setup:
    uses: ./.github/workflows/python-setup.yml
    
  test:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ needs.setup.outputs.python-version }}-pip-
            
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
      - name: Run tests
        run: |
          echo "=== Starting CI Test Run ==="
          echo "Python version: ${{ needs.setup.outputs.python-version }}"
          
          # Проверяем наличие папки tests
          if [ -d "tests" ]; then
            echo "Found tests/ directory"
            
            # Проверяем, есть ли файлы с тестами
            TEST_FILES=$(find tests -name "*.py" -type f 2>/dev/null)
            
            if [ -n "$TEST_FILES" ]; then
              echo "Found Python files in tests/:"
              echo "$TEST_FILES" | sed 's/^/  /'
              echo ""
              echo "Running tests with pytest..."
              python -m pytest tests/ -v
              echo "Tests completed"
            else
              echo "No Python files found in tests/ directory"
              echo "Skipping test execution"
            fi
          else
            echo "No tests/ directory found"
            echo "Skipping test execution"
          fi
          
          echo ""
          echo "=== Basic Environment Validation ==="
          
          # Базовая проверка окружения
          python -c "print('Python environment is functional')"
          
          # Проверяем установлен ли pytest
          if python -c "import pytest; print('pytest is available')" 2>/dev/null; then
            echo "pytest version: $(python -c "import pytest; print(pytest.__version__)")"
          fi
          
          echo ""
          echo "CI process completed successfully"
